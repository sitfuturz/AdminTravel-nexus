<div class="container-fluid">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <div class="card-header bg-gradient-primary d-flex justify-content-between align-items-center py-3">
      <h4 class="mb-0 fw-bold text-white">
        <i class="bi bi-calendar-event me-2"></i>Paid Event Status Update
      </h4>
    </div>
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <div class="d-flex w-100 align-items-center">
          <div class="flex-grow-1 me-2">
            <input type="text" class="form-control" placeholder="Search events..." [(ngModel)]="searchQuery" (input)="onSearch()">
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="loading" class="text-center my-5 py-5">
      <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div class="table-responsive" *ngIf="!loading && events?.docs?.length > 0">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
          <tr>
            <th class="ps-4 py-3">Serial No.</th>
            <th class="py-3">Title</th>
            <th class="py-3">Start Date</th>
            <th class="py-3">End Date</th>
            <th class="py-3">Created At</th>
            <th class="text-end pe-4 py-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let event of events.docs; let i = index">
            <td class="ps-4 py-3">{{events.pagingCounter + i}}</td>
            <td class="py-3">{{event.title || event.name || 'Untitled'}}</td>
            <td class="py-3">{{formatDate(event.startDate)}}</td>
            <td class="py-3">{{formatDate(event.endDate)}}</td>
            <td class="py-3">{{formatDate(event.createdAt)}}</td>
            <td class="text-end pe-4 py-3">
              <button class="btn btn-outline-primary rounded-pill" (click)="openViewRegistrationsModal(event)">
                <i class="bi bi-eye me-2"></i>View Registrations
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="d-flex justify-content-between align-items-center p-3">
        <span class="text-muted">
          Showing {{events.pagingCounter}} - {{Math.min(events.page * events.limit, events.totalDocs)}} of {{events.totalDocs}} events
        </span>
        <nav aria-label="Events pagination">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="!events.hasPrevPage">
              <button class="page-link" (click)="onPageChange(1)" [disabled]="!events.hasPrevPage"><i class="bi bi-chevron-double-left"></i></button>
            </li>
            <li class="page-item" [class.disabled]="!events.hasPrevPage">
              <button class="page-link" (click)="onPageChange(events.prevPage)" [disabled]="!events.hasPrevPage"><i class="bi bi-chevron-left"></i></button>
            </li>
            <li class="page-item active"><span class="page-link">{{events.page}}</span></li>
            <li class="page-item" [class.disabled]="!events.hasNextPage">
              <button class="page-link" (click)="onPageChange(events.nextPage)" [disabled]="!events.hasNextPage"><i class="bi bi-chevron-right"></i></button>
            </li>
            <li class="page-item" [class.disabled]="!events.hasNextPage">
              <button class="page-link" (click)="onPageChange(events.totalPages)" [disabled]="!events.hasNextPage"><i class="bi bi-chevron-double-right"></i></button>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <div *ngIf="!loading && (!events?.docs || events?.docs?.length === 0)" class="text-center my-5 py-4 px-4">
      <div class="empty-state">
        <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
        <h5>No Events Found</h5>
        <p class="text-muted">Try adjusting your search criteria.</p>
      </div>
    </div>
  </div>
</div>

<!-- View Registrations Modal -->
<div class="modal fade" id="viewRegistrationsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="viewRegistrationsModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content border-0 shadow rounded-4 overflow-hidden">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title fw-bold" id="viewRegistrationsModalTitle">
          <i class="bi bi-list-check me-2"></i> Registrations for {{selectedEvent?.title || 'Event'}}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" (click)="closeViewRegistrationsModal()"></button>
      </div>
      <div class="modal-body p-0">
        <div *ngIf="registrationsLoading" class="text-center py-5">
          <div class="spinner-grow text-primary" role="status">
            <span class="visually-hidden">Loading registrations...</span>
          </div>
          <p class="text-muted mt-2">Loading registrations...</p>
        </div>

        <div class="table-responsive" *ngIf="!registrationsLoading && registrations?.data?.docs?.length > 0">
          <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
              <tr>
                <th class="ps-4 py-3">Serial No.</th>
                <th class="py-3">User Name</th>
                <th class="py-3">Email</th>
                <th class="py-3">Payment ID</th>
                <th class="py-3">Payment Date</th>
                <th class="py-3">Screenshot</th>
                <th class="py-3">Status</th>
                <th class="py-3">Transaction ID</th>
                <th class="text-end pe-4 py-3">Update Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let reg of registrations.data.docs; let i = index">
                <td class="ps-4 py-3">{{registrations.data.pagingCounter + i}}</td>
                <td class="py-3">{{getUserName(reg.userId)}}</td>
                <td class="py-3">{{getUserEmail(reg.userId)}}</td>
                <td class="py-3">{{reg._id}}</td>
                <td class="py-3">{{getPaymentDate(reg)}}</td>
                <td class="py-3">
                  <img *ngIf="getScreenshotUrl(reg)" [src]="getScreenshotUrl(reg)" alt="Screenshot" style="width: 50px; height: auto;" class="rounded">
                  <span *ngIf="!getScreenshotUrl(reg)">N/A</span>
                </td>
                <td class="py-3">
                  <span class="badge rounded-pill" [ngClass]="{'bg-success': reg.status === 'completed', 'bg-warning': reg.status === 'pending', 'bg-danger': reg.status === 'refunded'}">
                    {{reg.status | titlecase}}
                  </span>
                </td>
                <td class="py-3">{{getTransactionId(reg)}}</td>
                <td class="text-end pe-4 py-3">
                  <select class="form-select form-select-sm"
                          [(ngModel)]="reg.status"
                          (ngModelChange)="updateStatus(reg, $event)">
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                    <option value="refunded">Refunded</option>
                  </select>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="!registrationsLoading && (!registrations?.data?.docs || registrations?.data?.docs?.length === 0)" class="text-center py-5">
          <i class="bi bi-list-ul fs-1 text-muted mb-3"></i>
          <h5>No Registrations Found</h5>
          <p class="text-muted">This event has no registrations yet.</p>
        </div>
      </div>
      <div class="modal-footer bg-light" *ngIf="!registrationsLoading && registrations?.data?.docs?.length > 0">
        <div class="d-flex justify-content-between align-items-center w-100">
          <span class="text-muted">
            Showing {{registrations?.data.pagingCounter}} - {{Math.min(registrations?.data.page * registrations?.data.limit, registrations?.data.totalDocs)}} of {{registrations?.data.totalDocs}} registrations
          </span>
          <nav aria-label="Registrations pagination">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" [class.disabled]="!registrations?.data.hasPrevPage">
                <button class="page-link" (click)="changeRegistrationsPage(1)" [disabled]="!registrations?.data.hasPrevPage"><i class="bi bi-chevron-double-left"></i></button>
              </li>
              <li class="page-item" [class.disabled]="!registrations?.data.hasPrevPage">
                <button class="page-link" (click)="changeRegistrationsPage(registrations.data.prevPage)" [disabled]="!registrations?.data.hasPrevPage"><i class="bi bi-chevron-left"></i></button>
              </li>
              <li class="page-item active"><span class="page-link">{{registrations?.data.page}}</span></li>
              <li class="page-item" [class.disabled]="!registrations?.data.hasNextPage">
                <button class="page-link" (click)="changeRegistrationsPage(registrations.data.nextPage)" [disabled]="!registrations?.data.hasNextPage"><i class="bi bi-chevron-right"></i></button>
              </li>
              <li class="page-item" [class.disabled]="!registrations?.data.hasNextPage">
                <button class="page-link" (click)="changeRegistrationsPage(registrations.data.totalPages)" [disabled]="!registrations?.data.hasNextPage"><i class="bi bi-chevron-double-right"></i></button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>